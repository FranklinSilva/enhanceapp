<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Conflicts</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header>

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills'>
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/3.5.0/pouchdb-3.5.0.min.js"
            >
                Download <strong>v3.5.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1>Conflicts</h1>
          

        </div>

      </div>
    


    <article>
  <div class="container">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
          <div data-spy="affix" data-offset-top="214" data-offset-bottom="450">
            <ul class="nav nav-silent nav-sidebar">
              

    
    
        
    
    <li >
    <a href="/guides/">Intro</a>
</li>


    
    
    <li >
    <a href="/guides/setup-couchdb.html">Setting up CouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/setup-pouchdb.html">Setting up PouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/databases.html">Working with databases</a>
</li>


    
    
    <li >
    <a href="/guides/documents.html">Working with documents</a>
</li>


    
    
    <li >
    <a href="/guides/async-code.html">Asynchronous code</a>
</li>


    
    
        
    
    <li >
    <a href="/guides/updating-deleting.html">Updating/deleting documents</a>
</li>


    
    
    <li >
    <a href="/guides/bulk-operations.html">Bulk operations</a>
</li>


    
    
    <li >
    <a href="/guides/attachments.html">Working with attachments</a>
</li>


    
    
    <li >
    <a href="/guides/replication.html">Replication</a>
</li>


    
    
    <li  class="active" >
    <a href="/guides/conflicts.html">Conflicts</a>
</li>


    
    
    <li >
    <a href="/guides/changes.html">Changes feed</a>
</li>


    
    
    <li >
    <a href="/guides/queries.html">Map/reduce queries</a>
</li>


    
    
    <li >
    <a href="/guides/compact-and-destroy.html">Compacting and destroying</a>
</li>


    
    
    <li >
    <a href="/guides/local-documents.html">Local documents</a>
</li>



            </ul>
          </div>
        </div>

        <div class="col-sm-9">
          <p>Conflicts are an unavoidable reality when dealing with distributed systems. And make no mistake: client-server <em>is</em> a distributed system.</p>

<p>CouchDB and PouchDB differ from many other sync solutions, because they bring the issue of conflicts front-and-center. With PouchDB, conflict resolution is entirely under your control.</p>

<div class="alert alert-info">


<div class="alert-text">


PouchDB exactly implements CouchDB's replication algorithm, so conflict resolution works the same in both. For the purposes of this article, "CouchDB" and "PouchDB" may be used interchangeably.

</div></div>

<h2>Two types of conflicts</h2>

<p>In CouchDB, conflicts can occur in two places: immediately, when you try to commit a new revision, or later, when two peers have committed changes to the same document. Let&#39;s call these <strong>immediate conflicts</strong> and <strong>eventual conflicts</strong>.</p>

<h3>Immediate conflicts</h3>

<p><strong>Immediate conflicts</strong> can occur with any API that takes a <code>rev</code> or a document with <code>_rev</code> as input &ndash; <code>put()</code>, <code>post()</code>, <code>remove()</code>, <code>bulkDocs()</code>, and <code>putAttachment()</code>. They manifest as a <code>409</code> (conflict) error:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">myDoc</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;someid&#39;</span><span class="p">,</span>
  <span class="nx">_rev</span><span class="o">:</span> <span class="s1">&#39;1-somerev&#39;</span>
<span class="p">};</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">myDoc</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// success</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">409</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// conflict!</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// some other error</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>In your code, <em>you should always be handling conflicts</em>. No matter how unlikely it may seem, 409s can and do occur.</p>

<p>For instance, if you are doing live replication, a document may be modified by somebody else while the user is working on it. If the remote changes are replicated to the local database before the user tries to commit their changes, then they will receive the above 409 error.</p>

<h4>Upsert</h4>

<p>In many cases, the most practical solution to the 409 problem is to retry the <code>put()</code> until it succeeds. If the user&#39;s intended change can be expressed as a <strong>delta</strong> (i.e. a change that doesn&#39;t depend on the current revision), then this is very easy to achieve.</p>

<p>Borrowing a phrase from MongoDB, let&#39;s call this an <strong>upsert</strong> (&quot;update or insert&quot;), and use the <a href="https://github.com/pouchdb/pouchdb-upsert">pouchdb-upsert</a> plugin to implement it:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">myDeltaFunction</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">counter</span><span class="o">++</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">doc</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">upsert</span><span class="p">(</span><span class="s1">&#39;my_id&#39;</span><span class="p">,</span> <span class="nx">myDeltaFunction</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// success!</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// error (not a 404 or 409)</span>
<span class="p">});</span>
</code></pre></div>
<p>This <code>upsert()</code> function takes a <code>docId</code> and <code>deltaFunction</code>, where the <code>deltaFunction</code> is just a function that takes a document and outputs a new document. (If the document does not exist, then an empty document is provided.)</p>

<p><code>pouchdb-upsert</code> also offers a <code>putIfNotExists()</code> function, which will create a document if it doesn&#39;t exist already. For more details, see <a href="https://github.com/pouchdb/pouchdb-upsert#readme">the plugin&#39;s documentation</a>. </p>

<h3>Eventual conflicts</h3>

<p>Now, let&#39;s move on to the second type: <strong>eventual conflicts</strong>.</p>

<p>Imagine two PouchDB databases have both gone offline. The two separate users each make modifications to the same document, and then they come back online at a later time.</p>

<p>Both users committed changes to the same version of the document, and their local databases did not throw 409 errors. What happens then?</p>

<p>This is the classic &quot;conflict&quot; scenario, and CouchDB handles it very elegantly. By default, CouchDB will choose an arbitrary winner based on a deterministic algorithm, which means both users will see the same winner once they&#39;re back online. However, since the replication history is stored, you can always go back in time to resolve the conflict.</p>

<p>To detect if a document is in conflict, you use the <code>{conflicts: true}</code> option when you <code>get()</code> it.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;docid&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">conflicts</span><span class="o">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do something with the doc</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle any errors</span>
<span class="p">});</span>
</code></pre></div>
<p>If the document has conflicts, then the <code>doc</code> will be returned with a <code>_conflicts</code> attribute, which may contain the IDs of conflicting revisions.</p>

<p>For instance, imagine the <code>doc</code> returned is the following:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="s2">&quot;docid&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_rev&quot;</span><span class="o">:</span> <span class="s2">&quot;2-x&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_conflicts&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;2-y&quot;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>Here we have two separate revisions (<code>2-x</code> and <code>2-y</code>) written by two separate databases, and one database&#39;s revision (<code>2-x</code>) has arbitrarily won.</p>

<div class="alert alert-warning">


<div class="alert-text">


<p>Normally, <code>_rev</code>s look more like <code>2-c1592ce7b31cc26e91d2f2029c57e621</code>, i.e. a digit followed by a very long hash. In these examples, <code>x</code> and <code>y</code> are used in place of the hash, for simplicity’s sake.</p>

 
</div></div>

<p>Notice that the document&#39;s current revision starts with <code>2-</code>, and the conflicting version also starts with <code>2-</code>, indicating that they&#39;re both at the same level of the revision tree. (Revision hashes start with <code>1-</code>, <code>2-</code>, <code>3-</code>, etc., which indicates their distance from the first, &quot;root&quot; revision. The root always starts with <code>1-</code>.)</p>

<p>Both databases will see the same conflict, assuming replication has completed. In fact, all databases in the network will see the exact same revision history &ndash; much like Git.</p>

<p>To fetch the losing revision, you simply <code>get()</code> it using the <code>rev</code> option:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;docid&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">rev</span><span class="o">:</span> <span class="s1">&#39;2-y&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// do something with the doc</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle any errors</span>
<span class="p">});</span>
</code></pre></div>
<p>At this point, you can present both versions to the user, or resolve the conflict automatically using your preferred conflict resolution strategy: last write wins, first write wins, <a href="https://www.gnu.org/software/rcs/">RCS</a>, etc.</p>

<p>To mark a conflict as resolved, all you need to do is <code>remove()</code> the unwanted revisions. So for instance, to remove <code>&#39;2-y&#39;</code>, you would do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;docid&#39;</span><span class="p">,</span> <span class="s1">&#39;2-y&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// yay, we&#39;re done</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle any errors</span>
<span class="p">});</span>
</code></pre></div>
<p>If you want to resolve the conflict by creating a new revision, you simply <code>put()</code> a new document on top of the current winner, and make sure that the losing revision is deleted.</p>

<div class="alert alert-info">


<div class="alert-text">


<p>PouchDB deviates from CouchDB’s replication algorithm in one small way: revision hashes aren’t deterministic. PouchDB is forced to do this, because CouchDB calculates its revision hashes in an Erlang-specific way.</p>

<p>In practice, this just means that PouchDB’s replication algorithm is slightly less efficient than CouchDB’s, for some very unlikely edge cases. For details, see <a href="https://github.com/pouchdb/pouchdb/issues/2451#issuecomment-77386826">this comment</a>.</p>

</div></div>

<h2>Accountants don&#39;t use erasers</h2>

<p>Another conflict resolution strategy is to design your database so that conflicts are impossible. In practice, this means that you never update or remove existing documents &ndash; you only create new documents.</p>

<p>This strategy has been called the &quot;every doc is a delta&quot; strategy. A classic use-case for this would be a checkbook app, where every document is simply an operation that increases or decreases the account balance:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">change</span><span class="o">:</span> <span class="mi">100</span><span class="p">}</span> <span class="c1">// balance increased by $100</span>
<span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">change</span><span class="o">:</span> <span class="o">-</span><span class="mi">50</span><span class="p">}</span> <span class="c1">// balance decreased by $50</span>
<span class="p">{</span><span class="nx">_id</span><span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="nx">change</span><span class="o">:</span> <span class="mi">200</span><span class="p">}</span> <span class="c1">// balance increased by $200</span>
</code></pre></div>
<p>In this system, it is impossible for two documents to conflict, because the document <code>_id</code>s are just timestamps. Ledger transactions are recorded in the order they were made, and at the end of the day, you only need to do an <code>allDocs()</code> or <code>query()</code> operation to sum the result.</p>

<p>The wisdom of this strategy can be expressed by the maxim: <a href="http://blogs.msdn.com/b/pathelland/archive/2007/06/14/accountants-don-t-use-erasers.aspx">&quot;Accountants don&#39;t use erasers&quot;</a>. Like a diligent accountant, your app can just add new documents when you want to make a change, rather than going back and scrubbing out previous changes.</p>

<p>There is also a PouchDB plugin that implements this strategy: <a href="https://github.com/redgeoff/delta-pouch">delta-pouch</a>.</p>

<h2>Next</h2>

<p>Now that we&#39;ve settled our conflicts, let&#39;s take a look at the changes feed.</p>




    

    

    

    

    

    

    

    

    

    

    
        
        

        <ul class="pager">
            
                <li class="previous">
                    <a href="/guides/replication.html">&larr; Replication</a>
                </li>
            
            
                <li class="next">
                    <a href="/guides/changes.html">Changes feed &rarr;</a>
                </li>
            
        </ul>
    

    

    

    

    


        <div>

    </div>

  </div>

</article>


    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }
      
      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      applicationCache.addEventListener('cached', onCached, false);
      applicationCache.addEventListener('noupdate', giveIntro, false);
    </script>
  </body>
</html>
