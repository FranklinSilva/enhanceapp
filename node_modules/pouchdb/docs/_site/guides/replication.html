<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Replication</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header>

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills'>
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/3.5.0/pouchdb-3.5.0.min.js"
            >
                Download <strong>v3.5.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1>Replication</h1>
          

        </div>

      </div>
    


    <article>
  <div class="container">
    <div class="row">
        <div id="sidebar" class="col-sm-3">
          <div data-spy="affix" data-offset-top="214" data-offset-bottom="450">
            <ul class="nav nav-silent nav-sidebar">
              

    
    
        
    
    <li >
    <a href="/guides/">Intro</a>
</li>


    
    
    <li >
    <a href="/guides/setup-couchdb.html">Setting up CouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/setup-pouchdb.html">Setting up PouchDB</a>
</li>


    
    
    <li >
    <a href="/guides/databases.html">Working with databases</a>
</li>


    
    
    <li >
    <a href="/guides/documents.html">Working with documents</a>
</li>


    
    
    <li >
    <a href="/guides/async-code.html">Asynchronous code</a>
</li>


    
    
        
    
    <li >
    <a href="/guides/updating-deleting.html">Updating/deleting documents</a>
</li>


    
    
    <li >
    <a href="/guides/bulk-operations.html">Bulk operations</a>
</li>


    
    
    <li >
    <a href="/guides/attachments.html">Working with attachments</a>
</li>


    
    
    <li  class="active" >
    <a href="/guides/replication.html">Replication</a>
</li>


    
    
    <li >
    <a href="/guides/conflicts.html">Conflicts</a>
</li>


    
    
    <li >
    <a href="/guides/changes.html">Changes feed</a>
</li>


    
    
    <li >
    <a href="/guides/queries.html">Map/reduce queries</a>
</li>


    
    
    <li >
    <a href="/guides/compact-and-destroy.html">Compacting and destroying</a>
</li>


    
    
    <li >
    <a href="/guides/local-documents.html">Local documents</a>
</li>



            </ul>
          </div>
        </div>

        <div class="col-sm-9">
          <p>PouchDB and CouchDB were designed for one main purpose: <strong>sync</strong>. Jason Smith has <a href="http://nodeup.com/thirtyseven">a great quote</a> about this:</p>

<blockquote>
<p>The way I like to think about CouchDB is this: CouchDB is bad at everything, <em>except syncing</em>. And it turns out that&#39;s the most important feature you could ever ask for, for many types of software.&quot;</p>
</blockquote>

<p>When you first start using CouchDB, you may become frustrated because it doesn&#39;t work quite like other databases. Unlike most databases, CouchDB requires you to manage revisions (<code>_rev</code>), which can be tedious.</p>

<p>However, CouchDB was designed with sync in mind, and this is exactly what it excels at. Many of the rough edges of the API serve this larger purpose. For instance, managing your document revisions pays off in the future, when you eventually need to start dealing with conflicts.</p>

<h2>CouchDB sync</h2>

<p>CouchDB sync has a unique design. Rather than relying on a master/slave architecture, CouchDB
supports a <strong>multi-master</strong> architecture. You can think of this as a system where any node can be written to or read from, and where you don&#39;t have to care which one is the &quot;master&quot; and which one is the &quot;slave.&quot; In CouchDB&#39;s egalitarian world, every citizen is as worthy as another.</p>

<p><a href="/static/img/offline_replication.gif" target="_blank">
  <img class="img-responsive"  src="/static/img/offline_replication.gif" alt="Offline replication with CouchDB. Thanks to IBM for the image: http://www.ibm.com/developerworks/library/wa-couchdb/" />
</a></p>

<p>When you use PouchDB, CouchDB, and other members of the Couch family, you
don&#39;t have to worry which database is the &quot;single source of truth.&quot; They all are. According to the CAP theorem, CouchDB is an AP database, meaning that it&#39;s <strong>P</strong>artitioned, 
every node is <strong>A</strong>vailable, and it&#39;s only eventually <strong>C</strong>onsistent.</p>

<p>To illustrate, imagine a multi-node architecture with CouchDB servers spread across several continents. As long as you&#39;re willing to wait, the data will eventually flow 
from Australia to Europe to North America to wherever. Users around the world running PouchDB in their browsers or <a href="https://github.com/couchbase/couchbase-lite-ios">Couchbase Lite</a>/<a href="https://github.com/cloudant/CDTDatastore">Cloudant Sync</a> in their smartphones experience the 
same privileges. The data won&#39;t show up instantaneously, but depending on the Internet connection speed, it&#39;s usually close enough to real-time.</p>

<p>In cases of conflict, CouchDB will choose an arbitrary winner that every node can agree upon deterministically. However, conflicts are still stored in the <strong>revision tree</strong> (similar to a Git history tree), which means that app developers can either surface the conflicts to the user, or just ignore them.</p>

<p>In this way, CouchDB replication &quot;just works.&quot;</p>

<h2>Setting up sync</h2>

<p>As you already know, you can create either local PouchDBs:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">localDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PouchDB</span><span class="p">(</span><span class="s1">&#39;mylocaldb&#39;</span><span class="p">)</span>
</code></pre></div>
<p>or remote PouchDBs:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">remoteDB</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PouchDB</span><span class="p">(</span><span class="s1">&#39;http://localhost:5984/myremotedb&#39;</span><span class="p">)</span>
</code></pre></div>
<p>This pattern comes in handy when you want to share data between the two.</p>

<p>The simplest case is <strong>unidirectional replication</strong>, meaning you just want one database to mirror its changes to a second one. Writes to the second database, however, will not propagate back to the master database.</p>

<p>To perform unidirectional replication, you simply do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">replicate</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// yay, we&#39;re done!</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// boo, something went wrong!</span>
<span class="p">});</span>
</code></pre></div>
<p>Congratulations, all changes from the <code>localDB</code> have been replicated to the <code>remoteDB</code>.</p>

<p>However, what if you want <strong>bidirectional replication</strong>? (Kinky!) You could do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">replicate</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">);</span>
<span class="nx">localDB</span><span class="p">.</span><span class="nx">replicate</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">);</span>
</code></pre></div>
<p>However, to make things easier for your poor tired fingers, PouchDB has a shortcut API:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">);</span>
</code></pre></div>
<p>These two code blocks above are equivalent. And the <code>sync</code> API supports all the same events as the <code>replicate</code> API:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// yay, we&#39;re in sync!</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// boo, we hit an error!</span>
<span class="p">});</span>
</code></pre></div>
<h2>Live replication</h2>

<p>Live replication (or &quot;continuous&quot; replication) is a separate mode where changes are propagated between the two databases as the changes occur. In other words, normal replication happens once, whereas live replication happens in real time.</p>

<p>To enable live replication, you simply specify <code>{live: true}</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">live</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// yo, something changed!</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// yo, we got an error! (maybe the user went offline?)</span>
<span class="p">})));</span>
</code></pre></div>
<p>However, there is one gotcha with live replication: what if the user goes offline? In those cases, an error will be thrown and replication will stop.</p>

<p>You can allow PouchDB to automatically handle this error, and retry until the connection is re-established, by using the <code>retry</code> option:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">retry</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// yo, something changed!</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;paused&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// replication was paused, usually because of a lost connection</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// replication was resumed</span>
<span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// totally unhandled error (shouldn&#39;t happen)</span>
<span class="p">})));</span>
</code></pre></div>
<p>This is ideal for scenarios where the user may be flitting in and out of connectivity, such as on mobile devices.</p>

<h2>Canceling replication</h2>

<p>Sometimes, you may want to manually cancel replication &ndash; for instance, because the user logged out. You can do so by calling <code>cancel()</code> and then waiting for the <code>&#39;complete&#39;</code> event:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">syncHandler</span> <span class="o">=</span> <span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">retry</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="nx">syncHandler</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// replication was canceled!</span>
<span class="p">});</span>

<span class="nx">syncHandler</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span> <span class="c1">// &lt;-- this cancels it</span>
</code></pre></div>
<p>The <code>replicate</code> API also supports canceling:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">replicationHandler</span> <span class="o">=</span> <span class="nx">localDB</span><span class="p">.</span><span class="nx">replicate</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">retry</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="nx">replicationHandler</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// replication was canceled!</span>
<span class="p">});</span>

<span class="nx">replicationHandler</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span> <span class="c1">// &lt;-- this cancels it</span>
</code></pre></div>
<h2>Fancy replication</h2>

<p>Any PouchDB object can replicate to any other PouchDB object. So for instance, you can replicate two remote databases, or two local databases. You can also replicate from multiple databases into a single one, or from a single database into many others.</p>

<p>This can be very powerful, because it enables lots of fancy scenarios. For example:</p>

<ol>
<li>You have an <a href="http://pouchdb.com/adapters.html#pouchdb_in_the_browser">in-memory PouchDB</a> that replicates with a local PouchDB, acting as a cache.</li>
<li>You have many remote CouchDB databases that the user may access, and they are all replicated to the same local PouchDB.</li>
<li>You have many local PouchDB databases, which are mirrored to a single remote CouchDB as a backup store.</li>
</ol>

<p>The only limits are your imagination and your disk space.</p>

<div class="alert alert-warning">


<div class="alert-text">


When you replicate between two remote databases, the changes flow through PouchDB. If this is not what you want, then you should <code>POST</code> directly to the CouchDB <code>_replicate</code> endpoint, as described in <a href='http://guide.couchdb.org/draft/replication.html'>the CouchDB replication guide</a>.

</div></div>

<h2>Related API documentation</h2>

<ul>
<li><a href="/api.html#replication">replication()</a></li>
<li><a href="/api.html#sync">sync()</a></li>
</ul>

<h2>Next</h2>

<p>Now that we have a grasp on replication, let&#39;s talk about an inconvenient fact of life: conflicts.</p>




    

    

    

    

    

    

    

    

    

    
        
        

        <ul class="pager">
            
                <li class="previous">
                    <a href="/guides/attachments.html">&larr; Working with attachments</a>
                </li>
            
            
                <li class="next">
                    <a href="/guides/conflicts.html">Conflicts &rarr;</a>
                </li>
            
        </ul>
    

    

    

    

    

    


        <div>

    </div>

  </div>

</article>


    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }
      
      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      applicationCache.addEventListener('cached', onCached, false);
      applicationCache.addEventListener('noupdate', giveIntro, false);
    </script>
  </body>
</html>
