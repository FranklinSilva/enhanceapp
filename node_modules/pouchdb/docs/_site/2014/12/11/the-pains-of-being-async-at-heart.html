<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Pains Of Being Async At Heart</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header>

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills'>
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/3.5.0/pouchdb-3.5.0.min.js"
            >
                Download <strong>v3.5.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1>The Pains Of Being Async At Heart</h1>
          

        </div>

      </div>
    


    <article class='container'>
  <div class='row'>
    <div class='col-md-offset-1 col-md-10'>
      
  







  

  

  
    
      
    
    
      
    
  

  

  




<div class="post">
  <div class="media">
    <a class="pull-left" href="#">
    <img class="media-object img-circle img-responsive" src='https://gravatar.com/avatar/030451d8cfc268d666bae9a7fe8d10ec' alt='Dale Harvey'>
    </a>
    <div class="media-body">
    <p>
      <strong>By:</strong> <a href="https://twitter.com/daleharvey">Dale Harvey</a><br>
      <strong>Published:</strong> 11 December 2014<br>
      
    </p>
    </div>
  </div>
</div>


      <p>If you are testing JavaScript you will likely have to test against async API&#39;s. These bring up some issues that you may not be familiar with if you are used to testing synchronous code. Here are a few things I have learnt working on the PouchDB test suite.</p>

<h3>Always wait for operations to complete before testing their result</h3>

<p>This is the 101 of testing async code but it is the foundation for almost every other problem:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>While this test may pass (although unlikely) it relies on a broken assumption that the write behind <code>.put</code> completes before the read behind <code>.get</code>. The proper way to test this is to wait until the <code>.put</code> is complete:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">);</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>As a side note <a href="http://www.html5rocks.com/en/tutorials/es6/promises/">Promises</a> are huge improvement over callbacks for testing async code which by nature often involves a long sequential series of steps.</p>

<h3><code>setTimeout</code> is almost always evil</h3>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Test that a local write gets synced to remote database</span>
<span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">localDB</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">remoteDB</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>The main issue with <code>setTimeout</code> is that nothing is guaranteed to complete before the <code>setTimeout</code> finishes. While testing locally 1000ms may be more than enough time for the sync to do its magic if you start testing against non local database with increased latency that 1000ms will often be too short for the test to pass. The correct way to test this would be to listen for an event or to poll for the value:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">changes</span> <span class="o">=</span> <span class="nx">remoteDB</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">changes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
  <span class="nx">done</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">localDB</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">remoteDB</span><span class="p">,</span> <span class="p">{</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">localDB</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">});</span>
</code></pre></div>
<p>The added benefit to this is that your test will complete as soon as possible instead of waiting the full 1000ms on every run.</p>

<h3>I said &quot;almost&quot;</h3>

<p>I have found one use case where <code>setTimeout</code> is useful and that is to &quot;prove a negative&quot;. This is a test that will pass if the <code>setTimeout</code> ran immediately, for example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// Test we only receive one change event for a write</span>
<span class="kd">var</span> <span class="nx">numChanges</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">changes</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">changes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">numChanges</span><span class="o">++</span><span class="p">;</span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">numChanges</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">done</span><span class="p">();</span>
  <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Try going through your tests and change any <code>setTimeout</code> to <code>setTimeout(fun, 0);</code>. If your test fails then it is likely broken.</p>

<h3>You should ensure your test is really really finished</h3>

<p>This has been a very tricky issue in PouchDB. You want to make sure that when you call <code>done()</code> on a test that you are absolutely finished with any processing otherwise your test may effect follow on tests, to take the previous example:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">changes</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">changes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
  <span class="nx">changes</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
  <span class="nx">done</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">});</span>
</code></pre></div>
<p>This test looks fine however inside <code>changes.cancel()</code> we may be doing some processing that happens asynchronously, specifically we may be aborting a HTTP request that we haven&#39;t processed the reply of yet and as we process the reply the next test may have started. This type of issue is extremely problematic as it can lead to unexpected behavour in tests that are not the cause of the problem.</p>

<p>In PouchDB we fix this with:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">changes</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">changes</span><span class="p">({</span><span class="nx">live</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="nx">changes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">change</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">change</span><span class="p">.</span><span class="nx">doc</span><span class="p">.</span><span class="nx">foo</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">);</span>
  <span class="nx">changes</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
<span class="p">});</span>
<span class="nx">changes</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;complete&#39;</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">put</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">});</span>
</code></pre></div>
<p>The <code>complete</code> event is fired when we are sure we have dealt with all the processing involved in that changes event listener and so we know the test is completed any processing when we call <code>done()</code>.</p>

<p>There are lots of issues when testing JavaScript but this hits on a few of the main issues we have had in PouchDB. I hope its helpful and would love to hear some issues you may have had with it.</p>

        </div>
  </div>
</article>


    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }
      
      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      applicationCache.addEventListener('cached', onCached, false);
      applicationCache.addEventListener('noupdate', giveIntro, false);
    </script>
  </body>
</html>
