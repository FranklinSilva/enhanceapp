<!DOCTYPE html>
<html lang="en" manifest="/manifest.appcache">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Secondary indexes have landed in PouchDB</title>
    <link rel="alternate" title="PouchDB, the JavaScript Database that Syncs!" type="application/rss+xml" href="/feed.xml">
    <link rel="stylesheet" href="/static/css/pouchdb.css" />
    <meta name="theme-color" content="#6ccb99">
    <meta name="msapplication-TileColor" content="#6ccb99">
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-42479701-1']);
      _gaq.push(['_trackPageview']);

      (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <link href='http://fonts.googleapis.com/css?family=Lato:400,700|Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>
  </head>

  <body data-spy="scroll" data-target="#sidebar">

    <header>

      <a href="https://github.com/pouchdb/pouchdb" target="_blank">
         <div class="ribbon">GitHub</div>
      </a>

      <div class="container">

        <a class="logo" href="/">
          <div class="logo-img"></div>
          <span class='logo-type'>PouchDB</span>
        </a>

        <ul class='nav nav-header nav-pills'>
          <li>
            <a class='btn btn-link btn-lg' href="/blog/">Blog</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/guides/">Guides</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/api.html">API</a>
          </li>
          <li>
            <a class='btn btn-link btn-lg' href="/learn.html">Learn</a>
          </li>
          <li>
            <a
                class='btn btn-primary btn-lg'
                href="https://github.com/pouchdb/pouchdb/releases/download/3.5.0/pouchdb-3.5.0.min.js"
            >
                Download <strong>v3.5.0</strong>
            </a>
          </li>
        </ul>

      </div>

    </header>
    
      <div class="page-head">

        <div class="container">

          <h1>Secondary indexes have landed in PouchDB</h1>
          

        </div>

      </div>
    


    <article class='container'>
  <div class='row'>
    <div class='col-md-offset-1 col-md-10'>
      
  







  

  
    
      
    
    
      
    
  

  

  

  




<div class="post">
  <div class="media">
    <a class="pull-left" href="#">
    <img class="media-object img-circle img-responsive" src='https://gravatar.com/avatar/c436dec61b906e27c963518d0ef1d972' alt='Nolan Lawson'>
    </a>
    <div class="media-body">
    <p>
      <strong>By:</strong> <a href="https://twitter.com/nolanlawson">Nolan Lawson</a><br>
      <strong>Published:</strong> 01 May 2014<br>
      
    </p>
    </div>
  </div>
</div>


      <p>With the release of PouchDB 2.2.0, we&#39;re happy to introduce a feature that&#39;s been cooking on the slow simmer for some time: secondary indexes, a.k.a. persistent map/reduce.</p>

<p>This is a powerful new tool for developers, since it allows you to index anything in your JSON documents &ndash; not just the doc IDs. Starting in 2.2.0, your data is sortable and searchable in ways that just weren&#39;t feasible before, thanks to a new cross-platform indexing engine we&#39;ve built to work with every supported backend - IndexedDB, WebSQL, and LevelDB (and soon: LocalStorage!).</p>

<p>As usual with PouchDB, the new API is modeled after CouchDB&#39;s.  So developers who are already familiar with the <a href="https://wiki.apache.org/couchdb/HTTP_view_API">CouchDB map/reduce API</a> will be up and running in no time.  </p>

<p>And did I mention?  It&#39;s fast.  Our <a href="https://gist.github.com/nolanlawson/11100235">performance tests</a> show that the new persistent map/reduce API could give you orders of magnitude improvements over the old on-the-fly <code>query()</code> method.  In a database containing 1,000 documents, we found queries in PouchDB 2.2.0 to be between 10 and 100 times faster than in PouchDB 2.1.2.</p>

<h2>Show me the code!</h2>

<p>Here&#39;s the old way to query:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">pouch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PouchDB</span><span class="p">(</span><span class="s1">&#39;mydb&#39;</span><span class="p">);</span>

<span class="c1">// temporary view, each doc is processed in-memory (slow)</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">},</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// found docs with name === &#39;foo&#39;</span>
<span class="p">});</span>
</code></pre></div>
<div class="alert alert-info">


<div class="alert-text">


The <code>emit</code> pattern is part of the standard <a href='http://couchdb.readthedocs.org/en/latest/couchapp/views/intro.html'>CouchDB map/reduce API</a>.  What the function basically says is, "for each document, emit <code>doc.name</code> as a key."

</div></div>

<p>And here&#39;s the new way:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// document that tells PouchDB/CouchDB</span>
<span class="c1">// to build up an index on doc.name</span>
<span class="kd">var</span> <span class="nx">myIndex</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;_design/my_index&#39;</span><span class="p">,</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;my_index&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">map</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span> <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="p">}.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="c1">// save it</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">myIndex</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// kick off an initial build, return immediately</span>
  <span class="k">return</span> <span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;my_index&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">stale</span><span class="o">:</span> <span class="s1">&#39;update_after&#39;</span><span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// query the index (much faster now!)</span>
  <span class="k">return</span> <span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;my_index&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// found docs with name === &#39;foo&#39;</span>
<span class="p">});</span>
</code></pre></div>
<h2>Ew, you put map/reduce in my JavaScript?</h2>

<p>First, let&#39;s define what map/reduce is, so you can understand why you might want it.</p>

<h4>Indexes in SQL databases</h4>

<p>Quick refresher on how indexes work: in relational databases like MySQL and PostgreSQL, you can usually query whatever field you want:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">pokemon</span> <span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Pikachu&#39;</span><span class="p">;</span>
</code></pre></div>
<p>But if you don&#39;t want your performance to be terrible, you first add an index:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">pokemon</span> <span class="k">ADD</span> <span class="k">INDEX</span> <span class="n">myIndex</span> <span class="k">ON</span> <span class="p">(</span><span class="n">name</span><span class="p">);</span>
</code></pre></div>
<p>The job of the index is to ensure the field is stored in a B-tree within the database, so your queries run in <em>O(log(n))</em> time instead of <em>O(n)</em> time.</p>

<h4>Indexes in NoSQL databases</h4>

<p>All of the above is also true in document stores like CouchDB and MongoDB, but conceptually it&#39;s a little different. By default, documents are assumed to be schemaless blobs with one primary key (called <code>_id</code> in both Mongo and Couch), and any other keys need to be specified separately.  The concepts are largely the same; it&#39;s mostly just the vocabulary that&#39;s different.</p>

<p>In CouchDB, queries are called <em>map/reduce functions</em>.  This is because, like most NoSQL databases, CouchDB is designed to scale well across multiple computers, and to perform efficient query operations in parallel. Basically, the idea is that you divide your query into a <em>map</em> function and a <em>reduce</em> function, each of which may be executed in parallel in a multi-node cluster.</p>

<h4>Map functions</h4>

<p>It may sound daunting at first, but in the simplest (and most common) case, you only need the <em>map</em> function.  A basic map function might look like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">myMapFunction</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>This is functionally equivalent to the SQL index given above.  What it essentially says is: &quot;for each document in the database, emit its name as a key.&quot;</p>

<p>And since it&#39;s just JavaScript, you&#39;re allowed to get as fancy as you want here:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">myMapFunction</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;pokemon&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;Pikachu&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;Pika pi!&#39;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Then you can query it:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// find pokemon with name === &#39;Pika pi!&#39;</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">myMapFunction</span><span class="p">,</span> <span class="p">{</span><span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;Pika pi!&#39;</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle result</span>
<span class="p">});</span>

<span class="c1">// find the first 5 pokemon whose name starts with &#39;P&#39;</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">myMapFunction</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;P\uffff&#39;</span><span class="p">,</span> <span class="nx">limit</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">include_docs</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle result</span>
<span class="p">});</span>
</code></pre></div>
<div class="alert alert-info">


<div class="alert-text">


The pagination options for <code>query()</code> &ndash; i.e., <code>startkey</code>/<code>endkey</code>/<code>key</code>/<code>keys</code>/<code>skip</code>/<code>limit</code>/<code>descending</code> &ndash; are exactly the same as with <code>allDocs()</code>. For a beginner's guide to pagination, read <a href='http://pouchdb.com/2014/04/14/pagination-strategies-with-pouchdb.html'>Pagination strategies with PouchDB</a>.

</div></div>

<h4>Reduce functions</h4>

<p>As for <em>reduce</em> functions, there are a few handy built-ins that do aggregate operations (<code>&#39;_sum&#39;</code>, <code>&#39;_count&#39;</code>, and <code>&#39;_stats&#39;</code>), and you can typically steer clear of trying to write your own:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="c1">// emit the first letter of each pokemon&#39;s name</span>
<span class="kd">var</span> <span class="nx">myMapReduceFun</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">map</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
  <span class="p">},</span>
  <span class="nx">reduce</span><span class="o">:</span> <span class="s1">&#39;_count&#39;</span>
<span class="p">};</span>
<span class="c1">// count the pokemon whose names start with &#39;P&#39;</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">myMapReduceFun</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="nx">reduce</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">group</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// handle result</span>
<span class="p">});</span>
</code></pre></div>
<p>If you&#39;re adventurous, though, you should check out the <a href="http://couchdb.readthedocs.org/en/latest/couchapp/views/intro.html">CouchDB documentation</a> or the <a href="http://pouchdb.com/api.html#query_database">PouchDB documentation</a> for details on reduce functions.</p>

<h2>Map/reduce, reuse, recycle</h2>

<p>PouchDB has actually had map/reduce queries since way before version 2.2.0, via the <code>query()</code> API. It had a big flaw, though: all queries were performed in-memory, reading in every document in the entire database just to perform a single operation.</p>

<p>This is fine when your data set is small, but it could be murder on large databases. On mobile devices especially, memory is a precious commodity, so you want to be as frugal as possible with the resources given to you by the OS.</p>

<p>The new persistent <code>query()</code> method is much more memory-efficient, and it won&#39;t read in the entire database unless you tell it to.  It has two modes:</p>

<ul>
<li>Temporary views (like the old system)</li>
<li>Persistent views (new system)</li>
</ul>

<p>Both of these concepts exist in CouchDB, and they&#39;re faithfully emulated in PouchDB.</p>

<h4>A room with a view</h4>

<p>First off, some vocabulary: CouchDB calls indexes <em>views</em>, and these views are stored in a special document called a <em>design document</em>. Basically, a design document describes a view, and a view describes a map/reduce query, which tells the database that you plan to use that query later, so it better start indexing it now. In other words, creating a view is the same as saying <code>CREATE INDEX</code> in a SQL database.</p>

<p><strong>Temporary views</strong> are exactly that &ndash; temporary. Instead of using a design document, you just call <code>pouch.query()</code>, so the view is created, written to disk, queried, and then poof, it&#39;s deleted.  That&#39;s why, in older version of PouchDB, we could get away with doing it all in-memory.</p>

<p>Crucially, though, temporary views have to do a full scan of all documents <em>every time you execute them</em>, along with all the reading and writing to disk that that entails, only to throw it away at the end.  That may be fine for quick testing during development, but in production it can be a big drag on performance.</p>

<p><strong>Persistent views</strong>, on the other hand, are a much better solution if you want your queries to be fast.  Persistent views need to be saved in a design document (hence &quot;persistent&quot;), so that the emitted fields are already indexed by the time you look them up.  Subsequent lookups don&#39;t need to do any additional writes to disk, unless documents have been added or modified, in which case only the updated documents need to be processed.</p>

<div class="alert alert-info">


<div class="alert-text">


<strong>Why design docs?</strong> <a href='http://guide.couchdb.org/draft/design.html'>Design documents</a> are special meta-documents that CouchDB uses for things like indexes, security, and schema validation (think: "designing" your database).  They are stored, updated, and deleted exactly like normal documents, but their <code>_id</code>s are prefixed with the reserved string <code>'_design/'</code>.  They also show up in <code>allDocs()</code> queries, but you can filter them out by using <code>{startkey: '_design0'}</code>.

</div></div>

<h4>Writing your first view</h4>

<p>A design document with a view looks just like a regular document.  The simplest one might look like this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">designDoc</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;_design/my_index&#39;</span><span class="p">,</span>
  <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;my_index&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">map</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
      <span class="p">}.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>All you need to do is <code>put()</code> this document into your database:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">pouch</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">designDoc</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// design doc created</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// if err.name === &#39;conflict&#39;, then</span>
  <span class="c1">// design doc already exists</span>
<span class="p">});</span>
</code></pre></div>
<p>&hellip; and then it will be available for querying using the name <code>&#39;my_index&#39;</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;my_index&#39;</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// do something with result</span>
<span class="p">});</span>
</code></pre></div>
<p>Whatever name you give, be sure to use the same one in both the <code>_id</code> (after <code>&#39;_design/&#39;</code>) and in the <code>views</code>; otherwise you will need to use the awkward format <code>&#39;my_design_doc_name/my_view_name&#39;</code> when you query.</p>

<div class="alert alert-info">


<div class="alert-text">


Technically, a design doc can contain multiple views, but there's really no advantage to this. Plus, it can even cause performance problems in CouchDB, since all the indexes are written to a single file. So we recommend that you create one view per design doc, and use the same name for both, in order to make things simpler.

</div></div>

<p>Since there&#39;s a lot of boilerplate involved in creating views, you can use the following helper function to create a simple design doc based on a name and a map function:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="nx">createDesignDoc</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">mapFunction</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ddoc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;_design/&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span>
    <span class="nx">views</span><span class="o">:</span> <span class="p">{</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">ddoc</span><span class="p">.</span><span class="nx">views</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">map</span><span class="o">:</span> <span class="nx">mapFunction</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="p">};</span>
  <span class="k">return</span> <span class="nx">ddoc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Then you just need to <code>put()</code> it:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">designDoc</span> <span class="o">=</span> <span class="nx">createDesignDoc</span><span class="p">(</span><span class="s1">&#39;my_index&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">pouch</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">designDoc</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// design doc created!</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// if err.name === &#39;conflict&#39;, then</span>
  <span class="c1">// design doc already exists</span>
<span class="p">});</span>
</code></pre></div>
<p>From now on, you can call <code>pouch.query(&#39;my_index&#39;)</code> and it will summon this design document for querying.</p>

<p>Just like regular documents, design docs can always be deleted or changed later. The index will be updated automatically the next time you <code>query()</code> it.</p>

<p>If you do this a lot, though, then old indexes will build up on disk.  You can call <code>pouch.viewCleanup()</code> to clean up any orphaned indexes. </p>

<div class="alert alert-warning">


<div class="alert-text">


<strong>Performance tip</strong>: Technically, the view will not be built up on disk until the first time you <code>query()</code> it.  So a good trick is to always call <code>query(viewName, {stale: 'update_after'})</code> after creating a view, to ensure that it starts building in the background.  You can also use <code>{stale: 'ok'}</code> to avoid waiting for the most up-to-date results. In the future, we may add an API for auto-updating.

</div></div>

<h4>For those who get nostalgic</h4>

<p>Of course, some of our loyal Pouchinistas may have been perfectly happy with the old way of doing things. The fact that the old <code>query()</code> function slurped the entire database into memory might have served them just fine, thank you.</p>

<p>To be sure, there are some legitimate use cases for this. If you don&#39;t store a lot of data, or if all your users are on desktop computers, or if you require closures (not supported by persistent views), then doing map/reduce in memory may have been fine for you. In fact, an upgrade to 2.2.0 might actually make your app <em>slower</em>, because now it has to read and write to disk.</p>

<p>Luckily we have a great solution for you: instead of using the <code>query()</code> API, you can use the much more straightforward <code>allDocs()</code> API.  This will read all documents into memory, just like before, but best of all, you can apply whatever functions you want to the data, without having to bother with learning a new API or even what the heck &quot;map/reduce&quot; is.</p>

<p>But in general, we strongly recommend upgrading your apps to the new API instead.</p>

<h2>When <em>not</em> to use map/reduce</h2>

<p>Now that I&#39;ve sold you on how awesome map/reduce is, let&#39;s talk about the situations where you might want to avoid it.</p>

<p>First off, you may have noticed that the CouchDB map/reduce API is pretty daunting.  As a newbie Couch user who very recently struggled with the API, I can empathize: the vocabulary is new, the concepts are (probably) new, and there&#39;s no easy way to learn it, except to clack at your keyboard for awhile and try it out.</p>

<p>Second off, views can take awhile to build up, both in CouchDB and PouchDB. Each document has to be fetched from the database, passed through the map function, and indexed, which is a costly procedure for large databases. And if your database is constantly changing, you will also incur the penalty at <code>query()</code> time of running the map function over the changed documents.</p>

<p>Luckily, it turns out that the primary index, <code>_id</code>, is often good enough for a variety of querying and sorting operations. So if you&#39;re clever about how you name your document <code>_id</code>s, you can avoid using map/reduce altogether.</p>

<p>For instance, say your documents are emails that you want to sort by recency: boom, just set the <code>_id</code> to <code>new Date().toJSON()</code>.  Or say they&#39;re web pages that you want to look up by URL: use the URL itself as the <code>_id</code>! Neither CouchDB nor PouchDB have a limit on how long your <code>_id</code>s can be, so you can get as fancy as you want with this.</p>

<h4>Use and abuse your doc IDs</h4>

<p>For a more elaborate example, let&#39;s imagine you&#39;re writing a music app.  Your database might contain artists:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">[</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;artist_bowie&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;artist&#39;</span><span class="p">,</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;David Bowie&#39;</span><span class="p">,</span>
    <span class="nx">age</span><span class="o">:</span> <span class="mi">67</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;artist_dylan&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;artist&#39;</span><span class="p">,</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Bob Dylan&#39;</span><span class="p">,</span>
    <span class="nx">age</span><span class="o">:</span> <span class="mi">72</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;artist_joni&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;artist&#39;</span><span class="p">,</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Joni Mitchell&#39;</span><span class="p">,</span>
    <span class="nx">age</span><span class="o">:</span> <span class="mi">70</span> <span class="p">}</span> <span class="p">]</span>
</code></pre></div>
<p>&hellip; as well as albums:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">[</span> <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_bowie_1971_hunky_dory&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_bowie&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Hunky Dory&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1971</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_bowie_1972_ziggy_stardust&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_bowie&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Rise and Fall of Ziggy Stardust and the Spiders from Mars&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1972</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_dylan_1964_times_they_are_changin&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_dylan&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;The Times They Are a-Changin\&#39;&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1964</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_dylan_1965_highway_61&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_dylan&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Highway 61 Revisited&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1965</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_dylan_1969_nashville_skyline&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_dylan&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Nashville Skyline&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1969</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">_id</span><span class="o">:</span> <span class="s1">&#39;album_joni_1974_court_and_spark&#39;</span><span class="p">,</span>
    <span class="nx">artist</span><span class="o">:</span> <span class="s1">&#39;artist_joni&#39;</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Court and Spark&#39;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;album&#39;</span><span class="p">,</span>
    <span class="nx">year</span><span class="o">:</span> <span class="mi">1974</span> <span class="p">}</span> <span class="p">]</span>
</code></pre></div>
<p>See what I did there? Artist-type documents are prefixed with <code>&#39;artist_&#39;</code>, and album-type documents are prefixed with <code>&#39;album_&#39;</code>.  This naming scheme is clever enough that we can already do lots of complex queries using <code>allDocs()</code>, even though we&#39;re storing two different types of documents.</p>

<p>Want to find all artists?  It&#39;s just:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">allDocs</span><span class="p">({</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;artist_&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;artist_\uffff&#39;</span><span class="p">});</span>
</code></pre></div>
<p>Want to list all the albums?  Try:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">allDocs</span><span class="p">({</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;album_&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;album_\uffff&#39;</span><span class="p">});</span>
</code></pre></div>
<p>How about all albums by David Bowie?  Wham bam, thank you ma&#39;am:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">allDocs</span><span class="p">({</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;album_bowie_&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;album_bowie_\uffff&#39;</span><span class="p">});</span>
</code></pre></div>
<p>Let&#39;s go even fancier. Can we find all of Bob Dylan&#39;s albums released between 1964 and 1965, in reverse order? Gather &#39;round people, and try this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">allDocs</span><span class="p">({</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;album_dylan_1965_&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;album_dylan_1964_\uffff&#39;</span><span class="p">,</span> <span class="nx">descending</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
</code></pre></div>
<p>In this example, you&#39;re getting all those &quot;indexes&quot; for free, each time a document is added to the database.  It doesn&#39;t take up any additional space on disk compared to the randomly-generated UUIDs, and you don&#39;t have to wait for a view to get built up, nor do you have to understand the map/reduce API at all.</p>

<p>Of course, this system starts to get shaky when you need to search by a variety of criteria: e.g. all albums sorted by year, artists sorted by age, etc. And you can only sort strings &ndash; not numbers, booleans, arrays, or arbitrary JSON objects, like the map/reduce API supports.  But for a lot of simple applications, you can get by without using the <code>query()</code> API at all.</p>

<div class="alert alert-warning">


<div class="alert-text">


<strong>Performance tip</strong>: if you're just using the randomly-generated doc IDs, then you're not only missing out on an opportunity to get a free index &ndash; you're also incurring the overhead of building an index you're never going to use. So use and abuse your doc IDs!

</div></div>

<h2>Tips for writing views</h2>

<p>When you do need the full map/reduce API, though, it pays to know the tips and tricks.  Below is a list of advanced techniques and common pitfalls, which you may find useful when you&#39;re trying to squeeze that last bit of performance out of your views.</p>

<p><strong>1. Don&#39;t index it if you don&#39;t need it</strong></p>

<p>If your database has several document types, but only the &quot;person&quot; type has a <code>lastName</code> field, do this:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">lastName</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">lastName</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>If you took out the <code>if</code> statement, you&#39;d emit a <code>null</code> key for every non-person in your database, which needlessly bloats the size of your index.</p>

<div class="alert alert-info">


<div class="alert-text">


If the <code>null</code> field is meaningful for some reason, though, you can emit it and look it up later using <code>query(viewName, {key: null})</code>.  Any <code>undefined</code> fields are treated as <code>null</code>.

</div></div>

<p><strong>2. Move logic to the query params</strong></p>

<p>Don&#39;t do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">highScore</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">highScore</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Instead, do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">highScore</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>And then query with <code>{startkey: 1000}</code>.</p>

<p><strong>3. Use high characters for prefix search</strong></p>

<p>To find every <code>lastName</code> that starts with an <code>&#39;L&#39;</code>, you can use the high Unicode character <code>&#39;\uffff&#39;</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">viewName</span><span class="p">,</span> <span class="p">{</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;L\uffff&#39;</span><span class="p">});</span>
</code></pre></div>
<p>Or you can set <code>inclusive_end</code> to <code>false</code>:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">viewName</span><span class="p">,</span> <span class="p">{</span><span class="nx">startkey</span><span class="o">:</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="nx">endkey</span><span class="o">:</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="nx">inclusive_end</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
</code></pre></div>
<p>Both queries will do the same thing.</p>

<p><strong>4. Use {} for complex key ranges</strong></p>

<p>If your keys are <code>[lastName, firstName]</code>, and you need to find everybody with the last name <code>&#39;Harvey&#39;</code>, you can do:</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="nx">pouch</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">viewName</span><span class="p">,</span> <span class="p">{</span><span class="nx">startkey</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Harvey&#39;</span><span class="p">],</span> <span class="nx">endkey</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;Harvey&#39;</span><span class="p">,</span> <span class="p">{}]});</span>
</code></pre></div>
<p>In <a href="http://couchdb.readthedocs.org/en/latest/couchapp/views/collation.html">CouchDB collation ordering</a>, <code>{}</code> is higher than everything except other objects.</p>

<h2>For the database geeks: implementation details</h2>

<p>If you want to know how map/reduce works in PouchDB, it&#39;s actually exceedingly easy: just open up your browser&#39;s developer tools, head over to &quot;Resources,&quot; and see where we&#39;ve created a bonus database to store the index.</p>

<p>One of the neat things about how we implemented map/reduce is that we managed to do it entirely within PouchDB itself.  Yep, that&#39;s right: your map/reduce view is just a regular old PouchDB database, and map/reduce itself is a plugin with no special privileges, creating databases in exactly the same way a regular user would.  Since the implementation sits on top of the PouchDB API, it&#39;s exactly the same for all three backends: LevelDB, IndexedDB, and WebSQL.</p>

<p>How did we pull off this trick?  To be clear: it&#39;s not like we set out to make PouchDB some kind of map/reduce engine.  In fact, as we were debating how to implement this feature, we originally ran on the assumption that we&#39;d need to build additional functionality on top of PouchDB. It was only after a few months of discussions and experiments that we realized the whole thing could be done in PouchDB proper.</p>

<p>In the end, the only additional functionality we had to add to the main PouchDB code was a hook to tell PouchDB to destroy the map/reduce database when its parent database was destroyed.  That&#39;s it.</p>

<p>This technique also has a nice parallel in CouchDB: it turns out that they, too, reused the core <code>_view</code> code in order to write <code>_all_docs</code>.  In CouchDB, <code>_all_Docs</code> is just a special kind of <code>_view</code>, whereas in PouchDB, we built map/reduce views on top of <code>allDocs()</code>.  We did it backwards, but the spirit of the idea was the same.</p>

<p>As for the index itself, what it basically boils down to is clever serialization of arbitrary JSON values into <a href="http://couchdb.readthedocs.org/en/latest/couchapp/views/collation.html">CouchDB collation ordering</a> &ndash; i.e. nulls before booleans, booleans before numbers, numbers before strings, strings before arrays, arrays before objects, and so on recursively.  Every JSON object maps to an indexable string that guarantees the same ordering in every database backend, and we only deviate from CouchDB by using ASCII string ordering instead of ICU ordering (since that&#39;s what our backends use).</p>

<p>Then, we take this value and concatenate it with whatever else needs to be indexed (usually just the doc <code>_id</code>), meaning the entire lookup key is a single string.  We decided on this implementation because:</p>

<ol>
<li>LevelDB does not support complex indexes.</li>
<li>IndexedDB <em>does</em> support complex indexes, but <a href="https://gist.github.com/nolanlawson/8330172">not in IE</a>.</li>
<li>WebSQL supports multi-field indexes, but it&#39;s also a dead spec, so we&#39;re not going to prioritize it above the others.</li>
</ol>

<p>The next part of the design was to divide the data we needed to store into two kinds of documents: 1) emitted key/values with doc IDs, which are used for querying and pagination, and 2) mappings from doc IDs to those key/values, so that we can delete or update them when their parent documents are deleted or updated. Since by design, PouchDB databases do not have multi-document transaction semantics, we implemented a task queue on top of the database to serialize writes.</p>

<p>Aside from that, the only other neat trick was a liberal use of <code>_local</code> documents, which are a special class of documents that aren&#39;t counted in the <code>total_rows</code> count, don&#39;t show up in <code>allDocs</code>, but can still be accessed using the normal <code>put()</code> and <code>get()</code> methods.  This is all it takes to fully reimplement CouchDB map/reduce in a tiny JavaScript database!</p>

<p>Anyone interested in more implementation details can read the months-long discussions in <a href="https://github.com/pouchdb/mapreduce/issues/12">these</a> <a href="https://github.com/pouchdb/pouchdb/issues/1549">Github</a> <a href="https://github.com/pouchdb/pouchdb/issues/1658">issues</a>.  The <a href="https://github.com/pouchdb/mapreduce">map/reduce code</a> itself is also pretty succinct.</p>

        </div>
  </div>
</article>


    <div class="icons">

      <div class="container">

        <div class="row">

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://twitter.com/pouchdb' target='_blank'>
              <div class="icon icon-twitter"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/rvagg/node-levelup' target='_blank'>
              <div class="icon icon-leveldb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://github.com/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-github"></div>
            </a>
            </div>

          <div class='col-xs-4 col-md-offset-0 col-md-2'>
            <a href='https://travis-ci.org/pouchdb/pouchdb' target='_blank'>
              <div class="icon icon-travis"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='http://couchdb.apache.org/' target='_blank'>
              <div class="icon icon-couchdb"></div>
            </a>
          </div>

          <div class='col-xs-4 col-md-2'>
            <a href='https://saucelabs.com' target='_blank'>
              <div class="icon icon-saucelabs"></div>
            </a>
          </div>

        </div>

      </div>

    </div>

    <footer class="footer">

      <div class="container">

        <div class="row">

          <div class='col-sm-3'>
            <h3 class="nav-head">Learn</h3>
            <ul class='nav nav-silent'>
              <li><a href="/getting-started.html">Getting Started</a></li>
              <li><a href="/api.html">API Guide</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/wiki">Wiki</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Discuss</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://groups.google.com/forum/#!forum/pouchdb">Mailing List</a></li>
              <li><a href="irc://freenode.net/#pouchdb">IRC</a></li>
              <li><a href="http://twitter.com/pouchdb">Twitter</a></li>
              <li><a href="http://stackoverflow.com/questions/tagged/pouchdb">StackOverflow</a></li>
            </ul>
          </div>

          <div class='col-sm-3'>
            <h3 class="nav-head">Contribute</h3>
            <ul class='nav nav-silent'>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/CONTRIBUTING.md">Contributing</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb">Source</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/issues">Issues</a></li>
              <li><a href="https://github.com/pouchdb/pouchdb/blob/master/LICENSE">Apache License</a></li>
            </ul>
          </div>

        </div>

      </div>

    </footer>
    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/static/js/code.min.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/pouchdb/latest/pouchdb.min.js"></script>
    <script type="text/javascript">
      function onCached(e) {
        if (applicationCache.status === 1) {
          giveIntro();
        }
      }
      
      function giveIntro() {
        console.log('%c\n..............................................................................\n.?I...........~+: ............................................................\n.???.........++++.............................................................\n:????+......+++++.............................................................\n.??????+++++++++:.................................H...........D..B............\n...????++++++++...................................H...........D..B............\n...=????++++++.......PPPPP...OOOO...U....U...CCCC.HHHHH...DDDDD..BBBBB........\n...?????+++++++......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n..???????+++++++ ....P. ..P.O....O..U....U.CC.....H...H..D....D..B....B.......\n..?????????????......P...:P.OO...O..U....U..C.....H...H..D....D..B....B.......\n...I??????????~......PPPPP...OOOO...=UUUUU...CCCC.H...H...DDDDD..BBBBB........\n....?????????~.......P.... ...................................................\n.....???????+........P........................................................\n......??????..................................................................\n..............................................................................\n..............................................................................\n..............................................................................', 'color: #4ec084');
        console.log('%c\nPouchDB itself is hosted at PouchDB.com!\nTo get started, try typing:\nvar db = new PouchDB(\'mydb\');', 'color: #4ec084');
      }
      applicationCache.addEventListener('cached', onCached, false);
      applicationCache.addEventListener('noupdate', giveIntro, false);
    </script>
  </body>
</html>
